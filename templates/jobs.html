{% extends "base.html" %}
{% block title %}Offres d'emploi | StageFinder{% endblock %}

{% block content %}
<h2>Offres d'emploi et de stage</h2>

<!-- ✅ Recruiter Form -->
{% if user.role.name == 'RECRUITER' %}
<div class="card">
    <h3>Publier une nouvelle offre</h3>
    <form method="POST">
        <div class="form-group">
            <label>Titre</label>
            <input type="text" name="title" required>
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea name="description" required></textarea>
        </div>
        <div class="form-group">
            <label>Salaire (facultatif)</label>
            <input type="text" name="salary">
        </div>
        <div class="form-group">
            <label>Lieu</label>
            <input type="text" name="location">
        </div>
        <div class="form-group">
            <label><input type="checkbox" name="is_remote"> Travail à distance</label>
        </div>
        <button type="submit" class="btn">Publier</button>
    </form>
</div>
{% endif %}


<!-- ✅ Job Feed -->
<h3>Liste des offres</h3>
{% for job in jobs %}
<div class="card">
    <h4>{{ job.title }}</h4>
    <p>{{ job.description }}</p>
    <p><strong>Lieu:</strong> {{ job.location or 'Non spécifié' }}</p>
    <p><strong>Salaire:</strong> {{ job.salary or 'Non spécifié' }}</p>
    <p><strong>Type:</strong> {{ 'Télétravail' if job.is_remote else 'Sur site' }}</p>
    <p><small>Posté par {{ job.recruiter.firstname }} {{ job.recruiter.lastname }} le {{ job.timestamp.strftime('%Y-%m-%d') }}</small></p>

    {% if user.role.name == 'STUDENT' %}
        <!-- Apply button -->
        <form method="POST" action="{{ url_for('main.apply_job', job_id=job.id) }}" style="display:inline;">
            <button type="submit" class="btn">Postuler</button>
        </form>

        <!-- Rate -->
        <form method="POST" action="{{ url_for('main.rate_job', job_id=job.id) }}" style="display:inline;">
            <label>⭐</label>
            <select name="stars">
                {% for i in range(6) %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
            <button type="submit">Noter</button>
        </form>
    {% endif %}

    <!-- Average rating -->
    {% set ratings = job.ratings.all() %}
    {% if ratings %}
        {% set avg = (ratings | map(attribute='stars') | sum) / ratings|length %}
        <p><strong>Note moyenne:</strong> ⭐ {{ '%.1f' % avg }} / 5 ({{ ratings|length }} votes)</p>
    {% else %}
        <p><strong>Note moyenne:</strong> Aucune note</p>
    {% endif %}
</div>
{% else %}
<p>Aucune offre disponible pour le moment.</p>
{% endfor %}
{% endblock %}
